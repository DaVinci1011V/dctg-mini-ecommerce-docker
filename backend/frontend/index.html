<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Mini eCommerce | Product Listing</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background:#f6f7fb;}
      .container { max-width: 980px; margin: 40px auto; background: white; padding: 24px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,.06);}
      input, select, button { padding: 10px; border: 1px solid #dcdfe6; border-radius: 8px; width: 100%; box-sizing: border-box; }
      table { width: 100%; border-collapse: collapse; margin-top: 16px; }
      th, td { text-align: left; padding: 10px; border-bottom: 1px solid #eee; }
      .row { display: flex; gap: 12px; flex-wrap: wrap; }
      .tag { display:inline-block; padding: 2px 8px; border-radius:999px; background:#eef2ff; }
    </style>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script crossorigin src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const API_BASE = window.location.origin;
      function App() {
        const [items, setItems] = React.useState([]);
        const [loading, setLoading] = React.useState(false);
        const [page, setPage] = React.useState(1);
        const [limit, setLimit] = React.useState(10);
        const [total, setTotal] = React.useState(0);
        const [filters, setFilters] = React.useState({ category: '', inStock: '' });
        const [form, setForm] = React.useState({ name:'', price:'', category:'', inStock:true });
        const [token, setToken] = React.useState('');

        const fetchProducts = async () => {
          setLoading(true);
          const qs = new URLSearchParams({ 
            page, limit, 
            ...(filters.category ? { category: filters.category } : {}),
            ...(filters.inStock !== '' ? { inStock: filters.inStock } : {})
          }).toString();
          const res = await fetch(`${API_BASE}/products?${qs}`);
          const json = await res.json();
          setItems(json.data || []);
          setTotal(json.total || 0);
          setLoading(false);
        };

        React.useEffect(() => { fetchProducts(); }, [page, limit, filters]);
        const pages = Math.ceil(total / limit) || 1;

        async function login(e) {
          e.preventDefault();
          const res = await fetch(`${API_BASE}/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: 'admin', password: 'admin123' })
          });
          const json = await res.json();
          if (res.ok) setToken(json.token); else alert(json.error || 'Login failed');
        }

        async function addProduct(e) {
          e.preventDefault();
          const res = await fetch(`${API_BASE}/products`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', ...(token ? {'Authorization': `Bearer ${token}`} : {}) },
            body: JSON.stringify({ name: form.name, price: parseFloat(form.price), category: form.category, inStock: !!form.inStock })
          });
          if (!res.ok) { const err = await res.json(); alert('Add failed: ' + (err.error || res.status)); return; }
          setForm({ name:'', price:'', category:'', inStock:true });
          setPage(1);
          fetchProducts();
        }

        return (
          <div className="container">
            <h1>Mini eCommerce — Products</h1>
            <div className="row">
              <select value={filters.category} onChange={e=>setFilters(f=>({...f, category:e.target.value}))}>
                <option value="">All categories</option>
                <option>Electronics</option>
                <option>Accessories</option>
                <option>Stationery</option>
              </select>
              <select value={filters.inStock} onChange={e=>setFilters(f=>({...f, inStock:e.target.value}))}>
                <option value="">All stock</option>
                <option value="1">In Stock</option>
                <option value="0">Out of Stock</option>
              </select>
              <select value={limit} onChange={e=>setLimit(Number(e.target.value))}>
                <option value="5">5</option><option value="10">10</option><option value="20">20</option>
              </select>
              <span>{loading ? 'Loading…' : `${total} items`}</span>
            </div>

            <table>
              <thead><tr><th>Name</th><th>Price (AED)</th><th>Category</th><th>Stock</th><th>Created</th></tr></thead>
              <tbody>
                {items.map(p => (
                  <tr key={p.id}>
                    <td>{p.name}</td>
                    <td>{p.price.toFixed ? p.price.toFixed(2) : p.price}</td>
                    <td><span className="tag">{p.category}</span></td>
                    <td>{p.inStock ? 'In stock' : 'Out of stock'}</td>
                    <td>{new Date(p.createdAt).toLocaleString()}</td>
                  </tr>
                ))}
                {!items.length && !loading && <tr><td colSpan="5">No products</td></tr>}
              </tbody>
            </table>

            <div className="row" style={{marginTop:12, alignItems:'center'}}>
              <button disabled={page<=1} onClick={()=>setPage(p=>p-1)}>Prev</button>
              <span>Page {page} / {pages}</span>
              <button disabled={page>=pages} onClick={()=>setPage(p=>p+1)}>Next</button>
            </div>

            <h2 style={{marginTop:24}}>Admin Actions</h2>
            {!token && <button onClick={login}>Login as admin</button>}
            {token && (
              <form className="row" onSubmit={addProduct}>
                <input placeholder="Product name" value={form.name} onChange={e=>setForm({...form, name:e.target.value})} required/>
                <input placeholder="Price" type="number" step="0.01" value={form.price} onChange={e=>setForm({...form, price:e.target.value})} required/>
                <input placeholder="Category" value={form.category} onChange={e=>setForm({...form, category:e.target.value})} required/>
                <select value={form.inStock ? '1':'0'} onChange={e=>setForm({...form, inStock: e.target.value==='1'})}>
                  <option value="1">In Stock</option><option value="0">Out of Stock</option>
                </select>
                <button type="submit">Add</button>
              </form>
            )}
            <p style={{marginTop:12}}>API docs: <a href="/docs" target="_blank" rel="noreferrer">/docs</a></p>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>